name: AI Code Review (Gemini)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Code Changes
        id: diff
        run: |
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changes.diff
          echo "diff_file=changes.diff" >> $GITHUB_OUTPUT

      # jq ì„¤ì¹˜ ì¶”ê°€
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Gemini API í˜¸ì¶œ ë¡œì§ ìˆ˜ì •
      - name: Request Code Review from Gemini
        id: gemini_review
        run: |
          # diff íŒŒì¼ ë‚´ìš©ì„ JSONì— ì•ˆì „í•˜ê²Œ í¬í•¨ì‹œí‚¤ê¸° ìœ„í•´ ì´ìŠ¤ì¼€ì´í”„
          DIFF_CONTENT=$(jq -Rs . < ${{ steps.diff.outputs.diff_file }})

          # Gemini APIì— ë³´ë‚¼ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
          PROMPT="You are an expert Go developer acting as a code reviewer. Please review the following code changes (in git diff format) and provide feedback. Focus on code quality, best practices, potential bugs, and clarity. If there are no issues, simply respond with 'Looks good to me.'. --- GIT DIFF --- ${DIFF_CONTENT}"

          # API í˜ì´ë¡œë“œ ìƒì„±
          JSON_PAYLOAD=$(printf '{"contents":[{"parts":[{"text":%s}]}]}' "$(echo "$PROMPT" | jq -sRr @json)")

          # Gemini API í˜¸ì¶œ
          API_RESPONSE=$(curl -s -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}")

          # API ì‘ë‹µì—ì„œ ë¦¬ë·° í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
          REVIEW_COMMENT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          # GitHub Actionsì—ì„œ ë©€í‹°ë¼ì¸ ë¬¸ìì—´ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í˜•ì‹
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "### ğŸ¤– Gemini Code Review" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '${{ steps.gemini_review.outputs.review_comment }}'
            })

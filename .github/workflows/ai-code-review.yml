name: AI Code Review (Gemini)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PROMPT_TEMPLATE: |
        You are an expert Go developer and a meticulous code reviewer. Your task is to provide a thorough review of the following code changes (in git diff format). Your feedback must be in Korean.

        Your review should be constructive and detailed. Do not just find problems; propose concrete solutions and improvements.

        Your review must cover the following aspects:
        1.  **Code Quality & Best Practices:** Adherence to Go idioms, best practices, and project-specific conventions outlined in 'GEMINI.md' and '.gemini/CODING_STYLE.md'.
        2.  **Potential Bugs:** Identify any potential bugs, race conditions, or error handling issues.
        3.  **Clarity & Readability:** Assess if the code is clear, readable, and easy to maintain.
        4.  **Concrete Improvement Suggestions:** Provide specific suggestions for improvement. **Include code examples** of how the code could be rewritten or refactored for better performance, readability, or maintainability.
        5.  **Refactoring Opportunities:** Point out any opportunities for refactoring to reduce complexity or improve the design.

        If there are no issues and the code is perfect, you can respond with 'ì™„ë²½í•©ë‹ˆë‹¤. (LGTM!)'. Otherwise, provide a detailed review.

        --- GIT DIFF ---

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Code Changes
        id: diff
        run: |
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changes.diff
          echo "diff_file=changes.diff" >> $GITHUB_OUTPUT

      # jq ì„¤ì¹˜ ì¶”ê°€
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Gemini API í˜¸ì¶œ ë¡œì§ ìˆ˜ì •
      - name: Request Code Review from Gemini
        id: gemini_review
        run: |
          # diff íŒŒì¼ ë‚´ìš©ì„ JSONì— ì•ˆì „í•˜ê²Œ í¬í•¨ì‹œí‚¤ê¸° ìœ„í•´ ì´ìŠ¤ì¼€ì´í”„
          DIFF_CONTENT=$(jq -Rs . < ${{ steps.diff.outputs.diff_file }})

          # í…œí”Œë¦¿ê³¼ diff ë‚´ìš©ì„ í•©ì³ ìµœì¢… í”„ë¡¬í”„íŠ¸ êµ¬ì„±
          PROMPT="${PROMPT_TEMPLATE}${DIFF_CONTENT}"

          # API í˜ì´ë¡œë“œ ìƒì„±
          JSON_PAYLOAD=$(printf '{"contents":[{"parts":[{"text":%s}]}]}' "$(echo "$PROMPT" | jq -sRr @json)")

          # Gemini API í˜¸ì¶œí•˜ê³  HTTP ìƒíƒœ ì½”ë“œë¥¼ í•¨ê»˜ ë°›ìŒ
          API_RESPONSE=$(curl -s -w "\n%{http_code}" -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}")
          # HTTP ìƒíƒœ ì½”ë“œì™€ ì‘ë‹µ ë³¸ë¬¸ ë¶„ë¦¬
          HTTP_RESPONSE_LAST_LINE=$(echo "$API_RESPONSE" | tail -n1)
          API_BODY=$(echo "$API_RESPONSE" | sed '$d')

          # ë§ˆì§€ë§‰ ì¤„ì´ ìˆ«ìì¸ì§€ í™•ì¸í•˜ì—¬ HTTP ì½”ë“œë¡œ ì‚¬ìš©
          if [[ "$HTTP_RESPONSE_LAST_LINE" =~ ^[0-9]+$ ]]; then
            HTTP_CODE="$HTTP_RESPONSE_LAST_LINE"
          else
            # ìˆ«ìê°€ ì•„ë‹ˆë©´, API_BODYì— ì „ì²´ ì‘ë‹µì„ ë„£ê³ , ì½”ë“œëŠ” ì—ëŸ¬ë¡œ ì²˜ë¦¬
            HTTP_CODE="0" # Curl/network error
            API_BODY="$API_RESPONSE"
          fi

          # ë””ë²„ê¹…ì„ ìœ„í•´ API ì‘ë‹µ ë¡œê¹…
          echo "--- Gemini API Response ---"
          echo "HTTP Code: $HTTP_CODE"
          echo "Body: $API_BODY"
          echo "-------------------------"

          # API ì‘ë‹µì— ì—ëŸ¬ê°€ ìˆëŠ”ì§€ í™•ì¸ (HTTP ìƒíƒœ ì½”ë“œ ê¸°ì¤€)
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Gemini API call failed with HTTP status $HTTP_CODE."
            # ì—ëŸ¬ ë©”ì‹œì§€ê°€ JSON í˜•íƒœì¼ ê²½ìš° êµ¬ë¬¸ ë¶„ì„ ì‹œë„
            if echo "$API_BODY" | jq -e '.error.message' > /dev/null; then
                ERROR_MESSAGE=$(echo "$API_BODY" | jq -r '.error.message')
                echo "::error::Error Details: $ERROR_MESSAGE"
            else
                echo "::error::Could not parse error details from API response body: $API_BODY"
            fi
            exit 1
          fi

          # API ì‘ë‹µì—ì„œ ë¦¬ë·° í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
          REVIEW_COMMENT=$(echo "$API_BODY" | jq -r '.candidates[0].content.parts[0].text')

          # REVIEW_COMMENTê°€ nullì´ê±°ë‚˜ ë¹„ì–´ ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$REVIEW_COMMENT" ] || [ "$REVIEW_COMMENT" = "null" ]; then
            echo "::error::Failed to extract review comment from Gemini API response. The response may have an unexpected format or be empty."
            # ì•ˆì „ ì„¤ì • ë“±ìœ¼ë¡œ ì¸í•´ í›„ë³´ê°€ ì—†ëŠ” ê²½ìš° í™•ì¸
            if echo "$API_BODY" | jq -e '.candidates' > /dev/null; then
              echo "::warning::The 'candidates' field exists, but the comment text could not be extracted. This might be due to safety settings or an unusual response structure."
            fi
            exit 1
          fi

          # GitHub Actionsì—ì„œ ë©€í‹°ë¼ì¸ ë¬¸ìì—´ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í˜•ì‹
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "### ğŸ¤– Gemini ì½”ë“œ ë¦¬ë·°" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment to PR
        uses: actions/github-script@v7
        env:
          REVIEW_COMMENT: "${{ steps.gemini_review.outputs.review_comment }}"
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.REVIEW_COMMENT
            })
